# https://github.com/s3lcsum/gitops/blob/main/stacks/authentik/compose.yaml

x-default: &default
  image: ghcr.io/goauthentik/server:2025.12.3
  restart: always
  env_file:
    - /opt/authentik/authentik.env
  environment:
    AUTHENTIK_ERROR_REPORTING__ENABLED: "true"
    AUTHENTIK_LOG_LEVEL: debug
  volumes:
    - media:/media
    - templates:/templates
    - certs:/certs
    - /var/run/docker.sock:/var/run/docker.sock:rw
  user: "1000:996"
  networks:
    - proxy
    - database
    - authentik

services:
  server:
    <<: *default
    container_name: authentik-server
    command: server
    healthcheck:
      test: ["CMD", "ak", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      traefik.enable: true
      traefik.docker.network: proxy
      traefik.http.routers.authentik.rule: Host(`auth.lake.dominiksiejak.pl`)
      traefik.http.services.authentik.loadbalancer.server.port: 9000

      traefik.http.middlewares.authentik.forwardauth.address: http://authentik-server:9000/outpost.goauthentik.io/auth/traefik
      traefik.http.middlewares.authentik.forwardauth.trustForwardHeader: true
      traefik.http.middlewares.authentik.forwardauth.authResponseHeaders: X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version

  worker:
    <<: *default
    container_name: authentik-worker
    command: worker
    depends_on:
      - server
    networks:
      - authentik
      - database


networks:
  proxy:
    external: true
  database:
    external: true
  authentik:
    driver: bridge

volumes:
  media:
  templates:
  certs:
