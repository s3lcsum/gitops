# github.com/s3lcsum/gitops/stacks/authentik/compose.yaml

x-defaults: &defaults
  image: ghcr.io/goauthentik/server:2025.6.4
  environment:
    AUTHENTIK_LOG_LEVEL: "debug"
    AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
  env_file:
    - "/opt/authentik/authentik.env"
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - media:/media
    - certs:/certs
    - templates:/templates
  networks:
    - proxy
    - database

services:
  server:
    <<: *defaults
    container_name: authentik
    command: server
    ports:
      - "9000:9000"
    labels:
      traefik.enable: "true"
      traefik.http.routers.authentik.rule: "Host(`auth.lake.dominiksiejak.pl`)"

  worker:
    <<: *defaults
    container_name: authentik-worker
    command: worker

  valkey:
    image: valkey/valkey:7-alpine
    container_name: authentik-valkey
    command: valkey-server --appendonly yes
    volumes:
      - valkey_data:/data
    networks:
      - database
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  proxy:
    external: true
  database:
    external: true

volumes:
  media:
  templates:
  certs:
  valkey_data:
