# https://github.com/s3lcsum/gitops/blob/main/stacks/mediabox/compose.yaml
# Description: Media server stack with VPN, torrent client, and automation tools
# DISCLAIMER: This require a lot of manual configuration.
# You can find the guide here: https://github.com/Morzomb/All-jellyfin-media-server/blob/Main/README.md

x-service-defaults: &service-defaults
  restart: unless-stopped
  networks: [proxy, arr]
  environment: &environment
    PUID: 0
    PGID: 0
    UMASK: 002
    TZ: Europe/Warsaw

services:
  # ðŸ”’ VPN gateway (WireGuard via Mullvad)
  gluetun:
    <<: *service-defaults
    image: ghcr.io/qdm12/gluetun:latest
    container_name: gluetun
    env_file:
      - /opt/mediabox/gluetun.env
    networks:
      - proxy
    cap_add:
      - NET_ADMIN
    shm_size: 1gb
    healthcheck: &healthcheck
      test: ["CMD-SHELL", "nc -z localhost 8000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ðŸ”’ Torrent client (VPN-routed)
  qbittorrent:
    <<: *service-defaults
    image: ghcr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment: *environment
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - qbittorrent_config:/config
      - /mnt/LOCAL_MEDIA/qbittorrent:/mnt/LOCAL_MEDIA/qbittorrent
    networks: []  # Override to empty since using network_mode
    network_mode: service:gluetun
    labels:
      traefik.enable: true
      traefik.http.services.qbittorrent.loadbalancer.server.port: 8080
      traefik.http.routers.qbittorrent.rule: Host(`qbittorrent.hello.dominiksiejak.pl`) || Host(`qbittorrent.lake.dominiksiejak.pl`)
      #traefik.http.routers.qbittorrent.middlewares: authentik@docker
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]

  # ðŸ“¥ Usenet downloader (VPN-routed)
  sabnzbd:
    <<: *service-defaults
    image: ghcr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    depends_on:
      gluetun:
        condition: service_healthy
    env_file:
      - /opt/mediabox/sabnzbd.env
    volumes:
      - sabnzbd_config:/config
      - /mnt/LOCAL_MEDIA/usenet:/mnt/LOCAL_MEDIA/usenet
      - /mnt/LOCAL_MEDIA/usenet/incomplete:/mnt/LOCAL_MEDIA/usenet/incomplete
    networks: []
    network_mode: service:gluetun
    labels:
      traefik.enable: true
      traefik.http.services.sabnzbd.loadbalancer.server.port: 8085
      traefik.http.routers.sabnzbd.rule: Host(`sabnzbd.hello.dominiksiejak.pl`) || Host(`sabnzbd.lake.dominiksiejak.pl`)
      #traefik.http.routers.sabnzbd.middlewares: authentik@docker
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8085/api?mode=version"]

  # ðŸŒ Cloudflare bypass for indexers
  flaresolverr:
    <<: *service-defaults
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    volumes:
      - flaresolverr_config:/app/data
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8191/"]

  prowlarr:
    <<: *service-defaults
    image: ghcr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    depends_on:
      flaresolverr:
        condition: service_healthy
    volumes:
      - prowlarr_config:/config
    labels:
      traefik.enable: true
      traefik.http.services.prowlarr.loadbalancer.server.port: 9696
      traefik.http.routers.prowlarr.rule: Host(`prowlarr.hello.dominiksiejak.pl`) || Host(`prowlarr.lake.dominiksiejak.pl`)
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]

  # ðŸŽ¥ Movie automation
  radarr:
    <<: *service-defaults
    image: ghcr.io/linuxserver/radarr:latest
    container_name: radarr
    depends_on:
      qbittorrent:
        condition: service_healthy
      sabnzbd:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    volumes:
      - radarr_config:/config
      - /mnt/LOCAL_MEDIA:/mnt/LOCAL_MEDIA
      - /mnt/NAS_Shared_Media:/mnt/NAS_Shared_Media
    labels:
      traefik.enable: true
      traefik.http.services.radarr.loadbalancer.server.port: 7878
      traefik.http.routers.radarr.rule: Host(`radarr.hello.dominiksiejak.pl`) || Host(`radarr.lake.dominiksiejak.pl`)
      #traefik.http.routers.radarr.middlewares: authentik@docker
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:7878/"]

  # ðŸ“º TV series automation
  sonarr:
    <<: *service-defaults
    image: ghcr.io/linuxserver/sonarr:latest
    container_name: sonarr
    depends_on:
      qbittorrent:
        condition: service_healthy
      sabnzbd:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
    volumes:
      - sonarr_config:/config
      - /mnt/LOCAL_MEDIA:/mnt/LOCAL_MEDIA
      - /mnt/NAS_Shared_Media:/mnt/NAS_Shared_Media
    labels:
      traefik.enable: true
      traefik.http.services.sonarr.loadbalancer.server.port: 8989
      traefik.http.routers.sonarr.rule: Host(`sonarr.hello.dominiksiejak.pl`) || Host(`sonarr.lake.dominiksiejak.pl`)
      #traefik.http.routers.sonarr.middlewares: authentik@docker
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8989/"]


  # ðŸ”„ Subtitle management
  bazarr:
    <<: *service-defaults
    image: ghcr.io/linuxserver/bazarr:latest
    container_name: bazarr
    volumes:
      - bazarr_config:/config
      - /mnt/LOCAL_MEDIA:/mnt/LOCAL_MEDIA
      - /mnt/NAS_Shared_Media:/mnt/NAS_Shared_Media
    labels:
      traefik.enable: true
      traefik.http.services.bazarr.loadbalancer.server.port: 6767
      traefik.http.routers.bazarr.rule: Host(`bazarr.hello.dominiksiejak.pl`) || Host(`bazarr.lake.dominiksiejak.pl`)
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:6767/"]

  # ðŸ“º Media server (primary)
  jellyfin:
    <<: *service-defaults
    image: ghcr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    volumes:
      - jellyfin_config:/config
      - /mnt/LOCAL_MEDIA/tv:/mnt/LOCAL_MEDIA/tv
      - /mnt/NAS_Shared_Media/tv:/mnt/NAS_Shared_Media/tv
      - /mnt/LOCAL_MEDIA/movies:/mnt/LOCAL_MEDIA/movies
      - /mnt/NAS_Shared_Media/movies:/mnt/NAS_Shared_Media/movies
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - "44"
      - "104"
    labels:
      traefik.enable: true
      traefik.http.services.jellyfin.loadbalancer.server.port: 8096
      traefik.http.routers.jellyfin.rule: Host(`jellyfin.hello.dominiksiejak.pl`) || Host(`jellyfin.lake.dominiksiejak.pl`)
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8096/"]

  # ðŸ“¥ Request manager
  seerr:
    <<: *service-defaults
    container_name: seerr
    image: fallenbagel/jellyseerr:preview-OIDC
    depends_on:
      jellyfin:
        condition: service_healthy
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    volumes:
      - jellyseerr_config:/app/config
    labels:
      traefik.enable: true
      traefik.http.routers.jellyseerr.rule: 'Host(`seerr.hello.dominiksiejak.pl`) || Host(`seerr.lake.dominiksiejak.pl`)'

networks:
  arr:
    driver: bridge
  proxy:
    external: true

volumes:
  qbittorrent_config:
  sabnzbd_config:
  radarr_config:
  sonarr_config:
  bazarr_config:
  jellyfin_config:
  jellyseerr_config:
  prowlarr_config:
  flaresolverr_config:
