# github.com/s3lcsum/gitops/stacks/postgres/compose.yaml
# WARNING: This file should not be edited anywhere except the git repository
# Any local changes will be overwritten by the git repository
#
# PostgreSQL Stack
# Database server
# Maintainer: Dominik Siejak

x-default: &default
  restart: unless-stopped
  networks:
    - database
    - metrics

x-healthchecks: &healthchecks
  start_period: 3s
  interval: 15s
  retries: 3
  timeout: 3s

services:
  postgres:
    <<: *default
    image: postgres:17
    container_name: postgres
    user: "999:999"
    env_file:
      - /Portainer/postgres/postgres.env
    volumes:
      - data:/var/lib/postgresql/data
      - /Portainer/postgres/00-init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    healthcheck:
      <<: *healthchecks
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]

  adminer:
    <<: *default
    image: adminer:latest
    container_name: adminer
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      traefik.http.routers.adminer.entrypoints: websecure
      traefik.http.services.adminer.loadbalancer.server.port: "8080"

networks:
  database:
    external: true
  metrics:
    external: true

volumes:
  data:
    driver: local
    driver_opts:
      type: none
      device: /var/lib/postgresql/data
      o: bind
